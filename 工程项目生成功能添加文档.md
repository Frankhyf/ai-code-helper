# 工程项目生成功能添加文档

## 一、功能概述

本文档详细记录了基于 doc7.txt 实现的 Vue 工程项目生成功能,包括:
1. 配置推理流式模型
2. 开发文件写入工具
3. 支持 Vue 项目生成
4. 工具调用流式输出
5. 统一消息格式
6. TokenStream 到 Flux 的适配
7. 流处理器开发
8. Vue 项目构建器
9. 修改部署逻辑支持 Vue 项目

## 二、新增文件清单

### 1. 配置类

#### `ReasoningStreamingChatModelConfig.java`
**路径**: `src/main/java/com/frank/aicodehelper/config/ReasoningStreamingChatModelConfig.java`
**功能**: 配置推理流式模型,用于 Vue 项目生成(带工具调用)
**关键配置**:
- 模型名称: deepseek-chat (测试) / deepseek-reasoner (生产)
- maxTokens: 8192 (测试) / 32768 (生产)

#### `OpenAiStreamingChatModelConfig.java`
**路径**: `src/main/java/com/frank/aicodehelper/config/OpenAiStreamingChatModelConfig.java`
**功能**: 配置默认流式模型,用于 HTML 和多文件生成
**说明**: 标记为 @Primary,作为默认的 StreamingChatModel bean

### 2. 工具类

#### `FileWriteTool.java`
**路径**: `src/main/java/com/frank/aicodehelper/ai/tools/FileWriteTool.java`
**功能**: AI 工具调用 - 文件写入工具
**关键方法**:
- `writeFile(String relativeFilePath, String content, Long appId)`: 写入文件到指定路径
**注意事项**:
- 使用 @ToolMemoryId 获取 appId 上下文
- 基于 appId 创建项目目录 `vue_project_{appId}`
- 返回相对路径,不暴露服务器绝对路径

### 3. 消息格式类

#### `StreamMessage.java`
**路径**: `src/main/java/com/frank/aicodehelper/ai/model/message/StreamMessage.java`
**功能**: 流式消息响应基类
**属性**: type (消息类型)

#### `AiResponseMessage.java`
**路径**: `src/main/java/com/frank/aicodehelper/ai/model/message/AiResponseMessage.java`
**功能**: AI 响应消息
**属性**: data (AI 响应内容)

#### `ToolRequestMessage.java`
**路径**: `src/main/java/com/frank/aicodehelper/ai/model/message/ToolRequestMessage.java`
**功能**: 工具调用消息
**属性**: id, name, arguments

#### `ToolExecutedMessage.java`
**路径**: `src/main/java/com/frank/aicodehelper/ai/model/message/ToolExecutedMessage.java`
**功能**: 工具执行结果消息
**属性**: id, name, arguments, result

### 4. 枚举类

#### `StreamMessageTypeEnum.java`
**路径**: `src/main/java/com/frank/aicodehelper/model/enums/StreamMessageTypeEnum.java`
**功能**: 流式消息类型枚举
**枚举值**:
- AI_RESPONSE: AI 响应
- TOOL_REQUEST: 工具请求
- TOOL_EXECUTED: 工具执行结果

### 5. 流处理器

#### `SimpleTextStreamHandler.java`
**路径**: `src/main/java/com/frank/aicodehelper/core/handler/SimpleTextStreamHandler.java`
**功能**: 简单文本流处理器,处理 HTML 和 MULTI_FILE 类型
**处理逻辑**:
- 收集 AI 响应内容
- 完成后保存到对话历史
- 错误时记录错误消息

#### `JsonMessageStreamHandler.java`
**路径**: `src/main/java/com/frank/aicodehelper/core/handler/JsonMessageStreamHandler.java`
**功能**: JSON 消息流处理器,处理 VUE_PROJECT 类型
**处理逻辑**:
- 解析 JSON 消息(AI 响应、工具请求、工具执行结果)
- 首次工具调用时输出 "[选择工具] 写入文件"
- 工具执行完成时输出完整的文件信息(Markdown 格式)
- 流式响应完成后异步构建 Vue 项目

#### `StreamHandlerExecutor.java`
**路径**: `src/main/java/com/frank/aicodehelper/core/handler/StreamHandlerExecutor.java`
**功能**: 流处理器执行器
**作用**: 根据代码生成类型选择合适的流处理器

### 6. 构建器

#### `VueProjectBuilder.java`
**路径**: `src/main/java/com/frank/aicodehelper/core/builder/VueProjectBuilder.java`
**功能**: Vue 项目构建器
**关键方法**:
- `buildProject(String projectPath)`: 同步构建 Vue 项目
  - 检查 package.json 是否存在
  - 执行 npm install
  - 执行 npm run build
  - 验证 dist 目录是否生成
- `buildProjectAsync(String projectPath)`: 异步构建 Vue 项目
  - 使用 Java 21 虚拟线程
  - 不阻塞主流程
**平台兼容性**: 
- Windows: npm.cmd
- Linux/Mac: npm

### 7. 提示词文件

#### `codegen-vue-project-system-prompt.txt`
**路径**: `src/main/resources/prompt/codegen-vue-project-system-prompt.txt`
**功能**: Vue 工程模式系统提示词
**关键内容**:
- 技术栈: Vue 3.x + Vite + Vue Router
- 项目结构定义
- 开发约束
- 参考配置(vite.config.js, router, package.json)
- 输出约束(必须使用文件写入工具)
- 质量检验标准

## 三、修改文件清单

### 1. `CodeGenTypeEnum.java`
**修改**: 添加 VUE_PROJECT 枚举值
```java
VUE_PROJECT("Vue 工程模式", "vue_project")
```

### 2. `AiCodeGeneratorService.java`
**修改**: 添加 Vue 项目生成方法
```java
@SystemMessage(fromResource = "prompt/codegen-vue-project-system-prompt.txt")
TokenStream generateVueProjectCodeStream(@MemoryId long appId, @UserMessage String userMessage);
```

### 3. `AiCodeGeneratorServiceFactory.java`
**修改**:
1. 注入两个 StreamingChatModel: `openAiStreamingChatModel` 和 `reasoningStreamingChatModel`
2. 修改缓存键构建逻辑,包含 codeGenType
3. 修改 `createAiCodeGeneratorService` 方法,根据生成类型选择不同的模型配置
   - VUE_PROJECT: 使用推理模型 + 文件写入工具 + 工具幻觉策略
   - HTML/MULTI_FILE: 使用默认模型

### 4. `AiCodeGeneratorFacade.java`
**修改**:
1. 添加 `processTokenStream` 方法,将 TokenStream 转换为 Flux
   - 监听 onPartialResponse 事件,封装为 AiResponseMessage
   - 监听 onToolExecuted 事件,封装为 ToolExecutedMessage
   - 所有消息转换为 JSON 字符串输出
2. 修改 `generateAndSaveCodeStream` 方法
   - 根据 appId 和 codeGenType 获取 AI 服务实例
   - VUE_PROJECT: 调用 generateVueProjectCodeStream 并通过 processTokenStream 适配

### 5. `AppServiceImpl.java`
**修改**:
1. 注入依赖: `StreamHandlerExecutor` 和 `VueProjectBuilder`
2. 修改 `chatToGenCode` 方法
   - 使用 `streamHandlerExecutor.doExecute` 处理流
3. 修改 `deployApp` 方法
   - Vue 项目特殊处理: 执行构建
   - 使用 dist 目录作为部署源

## 四、技术流程图

### 1. Vue 项目生成流程

```
用户发送消息
    ↓
AppController.chatToGenCode
    ↓
AppServiceImpl.chatToGenCode
    ↓
保存用户消息到对话历史
    ↓
AiCodeGeneratorFacade.generateAndSaveCodeStream
    ↓
根据 codeGenType 获取对应的 AI 服务实例
    ↓
调用 AI 服务生成 Vue 项目代码(TokenStream)
    ↓
processTokenStream 适配 TokenStream → Flux<String>
    ├─ 监听 AI 响应 → AiResponseMessage → JSON
    ├─ 监听工具调用 → ToolRequestMessage → JSON (仅首次)
    └─ 监听工具执行完成 → ToolExecutedMessage → JSON
    ↓
StreamHandlerExecutor.doExecute
    ↓
JsonMessageStreamHandler.handle
    ├─ 解析 JSON 消息
    ├─ 拼接对话历史内容
    └─ 流式输出给前端
    ↓
doOnComplete
    ├─ 保存 AI 消息到对话历史
    └─ 异步构建 Vue 项目(npm install + npm run build)
    ↓
返回流式响应给前端
```

### 2. AI 工具调用流程

```
AI 决定调用文件写入工具
    ↓
LangChain4j 框架拦截工具调用请求
    ↓
触发 TokenStream.onToolExecuted 事件
    ↓
获取 ToolExecution 对象
    ├─ id: 工具调用 ID
    ├─ name: writeFile
    ├─ arguments: {relativeFilePath, content}
    └─ result: 工具执行结果
    ↓
FileWriteTool.writeFile 被调用
    ├─ 从 @ToolMemoryId 获取 appId
    ├─ 构建项目目录: vue_project_{appId}
    ├─ 创建父目录
    └─ 写入文件内容
    ↓
返回工具执行结果给 AI
    ↓
AI 继续下一步操作或结束
```

### 3. Vue 项目部署流程

```
用户点击部署
    ↓
AppController.deployApp
    ↓
AppServiceImpl.deployApp
    ↓
检查应用是否存在
    ↓
检查用户权限
    ↓
生成或获取 deployKey
    ↓
检查源代码目录是否存在
    ↓
检测代码生成类型
    ↓
[如果是 VUE_PROJECT]
    ↓
VueProjectBuilder.buildProject(同步构建)
    ├─ 检查 package.json
    ├─ npm install (5分钟超时)
    ├─ npm run build (3分钟超时)
    └─ 验证 dist 目录
    ↓
将 dist 目录设为部署源
    ↓
[所有类型通用]
    ↓
复制文件到部署目录
    ↓
更新应用部署信息(deployKey, deployedTime)
    ↓
返回部署 URL
```

## 五、关键技术说明

### 1. TokenStream 流式输出

**问题**: LangChain4j 1.1.0 版本的 TokenStream 不支持工具调用流式输出
**解决方案**: 使用 TokenStream 的 `onToolExecuted` 事件,在工具执行完成后获取完整的工具调用信息
**注意**: 文档中提到的 `onPartialToolExecutionRequest` 需要覆盖 LangChain4j 源码,本实现未采用此方案

### 2. 流处理器模式

**设计目的**: 解耦不同生成类型的流处理逻辑
**实现方式**: 策略模式 + 执行器模式
- `SimpleTextStreamHandler`: 处理简单文本流(HTML, MULTI_FILE)
- `JsonMessageStreamHandler`: 处理 JSON 消息流(VUE_PROJECT)
- `StreamHandlerExecutor`: 根据生成类型选择合适的处理器

### 3. 工具调用上下文传递

**机制**: LangChain4j 的 `@ToolMemoryId` 注解
**作用**: 在工具方法中获取对话的 memoryId(本项目中为 appId)
**使用**:
```java
public String writeFile(
    @P("文件的相对路径") String relativeFilePath,
    @P("要写入文件的内容") String content,
    @ToolMemoryId Long appId  // 自动注入
)
```

### 4. 异步构建

**实现**: Java 21 虚拟线程
```java
Thread.ofVirtual().name("vue-builder-" + System.currentTimeMillis()).start(() -> {
    buildProject(projectPath);
});
```
**优点**: 不阻塞主流程,提高系统并发量
**缺点**: 前端可能无法实时浏览到生成的网站(需等待构建完成)

### 5. 工具幻觉策略

**配置**:
```java
.hallucinatedToolNameStrategy(toolExecutionRequest -> ToolExecutionResultMessage.from(
    toolExecutionRequest, "Error: there is no tool called " + toolExecutionRequest.name()
))
```
**作用**: 当 AI 调用不存在的工具时,框架自动返回错误消息给 AI

## 六、配置说明

### 1. application.yml

无需修改,推理模型配置复用现有的 `langchain4j.open-ai.chat-model` 配置项。

### 2. pom.xml

无需添加新依赖,所有功能基于现有依赖实现。

## 七、测试建议

### 1. 单元测试

```java
@Test
void generateVueProjectCodeStream() {
    Flux<String> codeStream = aiCodeGeneratorFacade.generateAndSaveCodeStream(
            "简单的任务记录网站,总代码量不超过 200 行",
            CodeGenTypeEnum.VUE_PROJECT, 1L);
    List<String> result = codeStream.collectList().block();
    Assertions.assertNotNull(result);
}
```

### 2. 集成测试

1. 创建应用时选择 Vue 工程模式
2. 发送生成请求,观察流式输出
3. 检查生成的文件结构
4. 执行部署,验证构建和部署流程
5. 访问部署 URL,验证网站是否正常运行

### 3. 注意事项

- 确保服务器已安装 Node.js 和 npm
- Windows 环境需要 npm.cmd
- 构建超时时间: npm install 5分钟, npm run build 3分钟
- 检查 tmp/code_output 和 tmp/code_deploy 目录权限

## 八、未实现的文档内容

根据用户要求"非必要情况下不要自己添加代码,以文档提供的内容为主",以下文档中提到但本实现未包含的内容:

### 1. TokenStream 工具调用流式输出增强

**文档位置**: 三、工程项目生成 -> 工具调用流式输出 -> 早期解决方案
**内容**: 通过覆盖 LangChain4j 源码实现 `onPartialToolExecutionRequest` 事件
**原因**: 
- 实现复杂度高
- 需要维护 LangChain4j 源码副本
- 现有方案已能满足基本功能

### 2. 前端开发

**文档位置**: 六、前端开发
**内容**: 
- 前端枚举类型补充
- 获取网站浏览地址函数修改
**原因**: 用户未明确要求实现前端代码

## 九、后续优化建议

1. **构建状态反馈**: 实现 WebSocket 或 SSE,实时推送 Vue 项目构建状态给前端
2. **构建日志记录**: 保存 npm install 和 npm run build 的详细日志,便于排查问题
3. **构建重试机制**: npm 安装失败时自动重试
4. **依赖缓存**: 缓存 node_modules 目录,加速构建
5. **工具调用流式输出**: 升级 LangChain4j 到 1.2+ 版本或覆盖源码,实现完整的工具调用流式输出

## 十、总结

本次功能开发严格按照 doc7.txt 文档要求,实现了完整的 Vue 工程项目生成功能,包括:

✅ 配置推理流式模型  
✅ 开发文件写入工具  
✅ 支持 Vue 项目生成  
✅ 工具调用流式输出(基础版)  
✅ 统一消息格式  
✅ TokenStream 到 Flux 的适配  
✅ 流处理器开发  
✅ Vue 项目构建器  
✅ 修改部署逻辑支持 Vue 项目  

所有核心功能均已实现,项目可以正常运行和测试。

