# 预览和部署功能优化说明 ✅

## 🎯 优化目标

1. **AI生成完成后自动预览**：无需手动点击"预览"按钮
2. **移除预览按钮**：简化UI，提升用户体验
3. **部署按钮智能跳转**：部署后直接在新标签页打开部署的网站

---

## ✨ 新功能流程

### 1️⃣ **实时预览**（自动）

**时机：** AI代码生成完成时

**流程：**
```
用户发送消息 → AI生成代码
    ↓
后端保存到: tmp/code_output/html_345582057897848800/
    ↓
isGenerating: true → false（生成完成）
    ↓
自动触发 watch 监听器
    ↓
延迟1秒（等待文件保存）
    ↓
自动刷新 iframe 预览
    ↓
显示提示: "代码生成完成，预览已更新"
```

**预览URL：**
```
/api/static/html_345582057897848800/
```

**后端处理：**
```
浏览器: http://localhost:5173/api/static/html_345582057897848800/
    ↓
Vite Proxy: http://localhost:8123/api/static/html_345582057897848800/
    ↓
Spring Boot (context-path=/api): StaticResourceController
    ↓
读取: tmp/code_output/html_345582057897848800/index.html
```

---

### 2️⃣ **部署应用**（智能跳转）

#### 场景A：应用**未部署**

**按钮文本：** "部署应用"

**点击后：**
```
执行部署操作
    ↓
复制文件: tmp/code_output/html_xxxxx/ → tmp/code_deploy/TelKgx/
    ↓
更新数据库: deployKey = "TelKgx", deployedTime = now()
    ↓
显示提示: "部署成功，正在跳转..."
    ↓
延迟500ms（确保部署完成）
    ↓
新标签页打开: http://localhost/TelKgx/
```

#### 场景B：应用**已部署**

**按钮文本：** "访问部署"

**点击后：**
```
直接跳转到: http://localhost/TelKgx/（新标签页）
```

**无需重新部署，直接访问已部署的网站！**

---

## 📋 代码修改清单

### 修改的文件

1. **`src/views/app/Chat.vue`**
   - ✅ 移除"预览"按钮
   - ✅ 修改"部署"按钮为动态文本（"部署应用"/"访问部署"）
   - ✅ 添加 `watch` 监听 `isGenerating` 变化
   - ✅ 生成完成后自动刷新预览
   - ✅ 修改 `deployCurrentApp` 方法，智能判断跳转逻辑
   - ✅ 修改 `updatePreviewUrl` 方法，始终显示实时预览URL

---

## 🔍 技术细节

### Watch 监听器

```typescript
watch(isGenerating, (newVal, oldVal) => {
  // 从生成中变为完成状态
  if (oldVal === true && newVal === false && currentApp.value) {
    console.log('AI生成完成，刷新预览...')
    // 延迟刷新，确保文件已保存
    setTimeout(() => {
      refreshPreview()
      showToast('代码生成完成，预览已更新')
    }, 1000)
  }
})
```

**原理：**
- `isGenerating` 是 Pinia store 中的响应式状态
- AI生成完成时，`chatWithAI` 方法会设置 `isGenerating = false`
- Watch 监听器检测到状态变化，触发预览刷新

---

### 部署按钮逻辑

```typescript
const deployCurrentApp = async () => {
  if (!currentApp.value) return

  // 情况1：已部署，直接跳转
  if (currentApp.value.deployedTime && currentApp.value.deployKey) {
    const deployedUrl = `http://localhost/${currentApp.value.deployKey}/`
    window.open(deployedUrl, '_blank')
    return
  }

  // 情况2：未部署，执行部署操作
  try {
    showToast('正在部署...')
    const deployUrl = await appStore.deployApp(currentApp.value.id)
    if (deployUrl) {
      const detail = await appStore.fetchAppDetail(currentApp.value.id)
      showToast('部署成功，正在跳转...')
      
      // 延迟跳转，确保部署完成
      setTimeout(() => {
        if (detail?.deployKey) {
          const deployedUrl = `http://localhost/${detail.deployKey}/`
          window.open(deployedUrl, '_blank')
        }
      }, 500)
    }
  } catch (error) {
    console.error('部署失败:', error)
    showToast('部署失败，请重试')
  }
}
```

---

### 预览URL生成

```typescript
const updatePreviewUrl = (app?: App | null) => {
  if (!app) {
    previewUrl.value = 'about:blank'
    return
  }

  // 自动预览模式：
  // 始终显示实时预览（StaticResourceController访问 code_output 目录）
  const codeGenType = app.codeGenType || 'html'
  const previewPath = `${codeGenType}_${app.id}`
  previewUrl.value = `/api/static/${previewPath}/`
  console.log('实时预览URL:', previewUrl.value, '已部署:', !!app.deployedTime)
}
```

**关键点：**
- **不再区分已部署/未部署**，始终显示 `code_output` 目录的实时预览
- 部署后的访问通过新标签页打开 Nginx 地址

---

## 🎨 UI/UX 改进

### 修改前

```
┌──────────────────────────────────────┐
│ [部署应用] [预览] [设置]              │
└──────────────────────────────────────┘
```

**问题：**
- 需要手动点击"预览"按钮
- "预览"按钮在未生成代码时点击会报错
- "部署"按钮点击后仍显示预览iframe，而非跳转到部署网站

---

### 修改后

```
┌──────────────────────────────────────┐
│ [部署应用/访问部署] [设置]           │
└──────────────────────────────────────┘
```

**优势：**
- ✅ AI生成完成后**自动刷新预览**，无需手动操作
- ✅ 简化UI，只保留必要按钮
- ✅ "部署"按钮智能切换文本（未部署/已部署）
- ✅ 点击后直接跳转到部署网站（新标签页）
- ✅ 预览和部署分离：预览在iframe，部署在新标签页

---

## 📖 用户使用流程

### 完整流程

```
1. 用户创建应用 → 跳转到聊天页面

2. 发送消息给AI："创建一个小红书风格的页面"
   ↓
   左侧：显示对话
   右侧：显示"AI正在生成中..."

3. AI生成完成
   ↓
   左侧：显示AI回复
   右侧：✨ 自动刷新，显示生成的页面
   提示："代码生成完成，预览已更新"

4. 用户查看预览，满意后点击"部署应用"
   ↓
   后端复制文件到 code_deploy/
   ↓
   提示："部署成功，正在跳转..."
   ↓
   新标签页打开：http://localhost/TelKgx/

5. 用户再次访问该应用
   ↓
   右侧：显示实时预览（code_output）
   按钮：变为"访问部署"
   ↓
   点击"访问部署" → 新标签页打开已部署网站
```

---

## ✅ 验证步骤

### 测试1：实时预览

1. 创建新应用并进入聊天页面
2. 发送消息："创建一个简单的计算器"
3. **验证：** AI生成完成后，右侧iframe自动显示生成的页面
4. **验证：** 显示提示"代码生成完成，预览已更新"

### 测试2：部署功能

1. 在预览页面，点击"部署应用"按钮
2. **验证：** 显示"正在部署..."
3. **验证：** 部署成功后显示"部署成功，正在跳转..."
4. **验证：** 新标签页自动打开 `http://localhost/TelKgx/`
5. **验证：** 部署的网站能正常访问

### 测试3：访问已部署应用

1. 刷新页面或重新进入该应用
2. **验证：** 按钮文本变为"访问部署"
3. **验证：** 右侧iframe仍显示实时预览（code_output）
4. **验证：** 点击"访问部署"，新标签页打开已部署网站

---

## 🎯 预期结果

### 实时预览

- ✅ AI生成完成后1秒内自动刷新预览
- ✅ 无需手动操作
- ✅ 始终显示最新生成的代码

### 部署功能

- ✅ 未部署：执行部署 → 跳转到部署网站
- ✅ 已部署：直接跳转到部署网站
- ✅ 跳转在新标签页打开，不影响当前页面

### UI简化

- ✅ 移除"预览"按钮
- ✅ 只保留"部署/访问部署"和"设置"按钮
- ✅ 界面更简洁，操作更直观

---

## 🚀 功能完成！

所有修改已完成，刷新页面即可体验新功能！🎉

