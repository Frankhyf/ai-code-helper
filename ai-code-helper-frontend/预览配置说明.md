# é¢„è§ˆåŠŸèƒ½é…ç½®è¯´æ˜

## ğŸ¯ é—®é¢˜åˆ†æ

æ‚¨é‡åˆ°çš„é—®é¢˜ï¼š
```
è®¿é—® http://localhost:5173/api/static/TelKgx/index.html
è¿”å› HTTP ERROR 404
```

**åŸå› ï¼š**
1. Viteä»£ç† `/api` è¯·æ±‚åˆ° `http://localhost:8123/api`
2. ä½†æ˜¯è®¿é—® `http://localhost:8123/api/static/TelKgx/` å¤±è´¥

**æ‚¨æåˆ°nginxé…ç½®å·²å®Œæˆï¼Œåº”è¯¥è®¿é—®ï¼š**
```
http://localhost/TelKgx/
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨nginxé¢„è§ˆï¼ˆæ¨èï¼Œç”Ÿäº§ç¯å¢ƒï¼‰

å‰ç«¯å·²ä¿®æ”¹ä¸ºï¼šå¦‚æœåº”ç”¨å·²éƒ¨ç½²ï¼ˆæœ‰deployedTimeï¼‰ï¼Œåˆ™ä½¿ç”¨nginxåœ°å€ã€‚

**å‰ç«¯é…ç½®ï¼ˆå·²å®Œæˆï¼‰ï¼š**
```typescript
if (app?.deployedTime) {
  // å·²éƒ¨ç½²ï¼Œä½¿ç”¨nginxåœ°å€
  previewUrl.value = `http://localhost/${deployKey}/`
} else {
  // å¼€å‘é¢„è§ˆï¼Œä½¿ç”¨åç«¯StaticResourceController
  previewUrl.value = `/api/static/${deployKey}/`
}
```

**nginxé…ç½®ç¤ºä¾‹ï¼š**
```nginx
server {
    listen 80;
    server_name localhost;
    
    # é™æ€èµ„æºæ ¹ç›®å½•
    root /path/to/code_deploy;
    
    # åº”ç”¨è®¿é—®è·¯å¾„ http://localhost/{deployKey}/
    location / {
        try_files $uri $uri/ /index.html;
        autoindex on;
    }
    
    # APIä»£ç†åˆ°åç«¯
    location /api/ {
        proxy_pass http://localhost:8123;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

### æ–¹æ¡ˆ2ï¼šåç«¯StaticResourceControllerï¼ˆå¼€å‘ç¯å¢ƒï¼‰

å¦‚æœè¦é€šè¿‡åç«¯è®¿é—®ï¼Œéœ€è¦ç¡®ä¿ï¼š

#### æ£€æŸ¥ç‚¹1ï¼šåç«¯å¸¸é‡é…ç½®

```java
public class AppConstant {
    // ä»£ç è¾“å‡ºæ ¹ç›®å½•ï¼ˆAIç”Ÿæˆä»£ç çš„ä¸´æ—¶ç›®å½•ï¼‰
    public static final String CODE_OUTPUT_ROOT_DIR = "tmp/code_output";
    
    // ä»£ç éƒ¨ç½²æ ¹ç›®å½•ï¼ˆnginxé™æ€èµ„æºç›®å½•ï¼‰
    public static final String CODE_DEPLOY_ROOT_DIR = "code_deploy";
}
```

#### æ£€æŸ¥ç‚¹2ï¼šStaticResourceControllerçš„PREVIEW_ROOT_DIR

**å½“å‰é…ç½®ï¼š**
```java
private static final String PREVIEW_ROOT_DIR = AppConstant.CODE_OUTPUT_ROOT_DIR;
```

è¿™æŒ‡å‘ `tmp/code_output`ï¼Œä½†æ‚¨è¯´æ–‡ä»¶åœ¨ `code_deploy`ã€‚

**åº”è¯¥æ”¹ä¸ºï¼š**
```java
private static final String PREVIEW_ROOT_DIR = AppConstant.CODE_DEPLOY_ROOT_DIR;
// æˆ–ç›´æ¥å†™
private static final String PREVIEW_ROOT_DIR = "code_deploy";
```

#### æ£€æŸ¥ç‚¹3ï¼šéƒ¨ç½²æœåŠ¡çš„ç›®å½•

ç¡®è®¤éƒ¨ç½²æœåŠ¡å°†æ–‡ä»¶å¤åˆ¶åˆ°äº†æ­£ç¡®çš„ç›®å½•ï¼š

```java
public String deployApp(Long appId, User loginUser) {
    // ... å‰ç½®æ£€æŸ¥
    
    // æºç›®å½•ï¼ˆAIç”Ÿæˆçš„ä»£ç ï¼‰
    String sourceDir = CODE_OUTPUT_ROOT_DIR + "/" + codeGenType + "_" + appId;
    
    // ç›®æ ‡ç›®å½•ï¼ˆéƒ¨ç½²ç›®å½•ï¼‰
    String deployKey = generateDeployKey(appId, codeGenType);
    String targetDir = CODE_DEPLOY_ROOT_DIR + "/" + deployKey;
    
    // å¤åˆ¶æ–‡ä»¶
    copyDirectory(sourceDir, targetDir);
    
    // è¿”å›éƒ¨ç½²URL
    return "http://localhost/" + deployKey + "/";
}
```

---

## ğŸ” è°ƒè¯•æ­¥éª¤

### æ­¥éª¤1ï¼šç¡®è®¤æ–‡ä»¶ä½ç½®

```bash
# æ£€æŸ¥ç”Ÿæˆç›®å½•
ls -la tmp/code_output/

# æ£€æŸ¥éƒ¨ç½²ç›®å½•
ls -la code_deploy/

# æ£€æŸ¥å…·ä½“çš„deployKeyç›®å½•
ls -la code_deploy/TelKgx/
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```
code_deploy/
  â””â”€â”€ TelKgx/
      â””â”€â”€ index.html
```

---

### æ­¥éª¤2ï¼šæµ‹è¯•åç«¯StaticResourceController

**ç›´æ¥è®¿é—®åç«¯ï¼š**
```
http://localhost:8123/api/static/TelKgx/
```

**å¦‚æœè¿”å›404ï¼Œæ£€æŸ¥ï¼š**

1. **PREVIEW_ROOT_DIRæ˜¯å¦æ­£ç¡®**
   ```java
   System.out.println("é¢„è§ˆæ ¹ç›®å½•: " + PREVIEW_ROOT_DIR);
   ```

2. **æ–‡ä»¶è·¯å¾„æ„å»ºæ˜¯å¦æ­£ç¡®**
   ```java
   String filePath = PREVIEW_ROOT_DIR + "/" + deployKey + resourcePath;
   System.out.println("æŸ¥æ‰¾æ–‡ä»¶: " + filePath);
   File file = new File(filePath);
   System.out.println("æ–‡ä»¶å­˜åœ¨: " + file.exists());
   ```

3. **è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„è¿˜æ˜¯ç›¸å¯¹è·¯å¾„**
   ```java
   // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç¡®ä¿å¯åŠ¨ç›®å½•æ­£ç¡®
   String absolutePath = new File(PREVIEW_ROOT_DIR).getAbsolutePath();
   System.out.println("ç»å¯¹è·¯å¾„: " + absolutePath);
   ```

---

### æ­¥éª¤3ï¼šæµ‹è¯•nginxè®¿é—®

**ç›´æ¥è®¿é—®nginxï¼š**
```
http://localhost/TelKgx/
```

**å¦‚æœè¿”å›404ï¼Œæ£€æŸ¥nginxé…ç½®ï¼š**

```bash
# æ£€æŸ¥nginxé…ç½®
nginx -t

# é‡å¯nginx
nginx -s reload

# æŸ¥çœ‹nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log
```

---

## ğŸ¯ æ¨èé…ç½®ï¼ˆäºŒé€‰ä¸€ï¼‰

### é…ç½®Aï¼šçº¯nginxæ–¹æ¡ˆï¼ˆæ¨èç”Ÿäº§ï¼‰

**åç«¯ï¼š**
- éƒ¨ç½²æœåŠ¡å¤åˆ¶æ–‡ä»¶åˆ° `code_deploy/`
- è¿”å›nginx URLï¼š`http://localhost/{deployKey}/`

**å‰ç«¯ï¼š**
- ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„URL
- ä¸ç»è¿‡Viteä»£ç†

**nginxï¼š**
- ç›‘å¬80ç«¯å£
- rootæŒ‡å‘ `code_deploy/`

**ä¼˜ç‚¹ï¼š**
- æ€§èƒ½å¥½ï¼ˆnginxç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶ï¼‰
- é…ç½®ç®€å•
- é€‚åˆç”Ÿäº§ç¯å¢ƒ

---

### é…ç½®Bï¼šå¼€å‘ç¯å¢ƒæ··åˆæ–¹æ¡ˆ

**åç«¯ï¼š**
- StaticResourceControlleræœåŠ¡é™æ€æ–‡ä»¶
- PREVIEW_ROOT_DIR = `code_deploy`
- è¿”å›åç«¯URLï¼š`http://localhost:8123/api/static/{deployKey}/`

**å‰ç«¯ï¼š**
- é€šè¿‡Viteä»£ç†è®¿é—® `/api/static/`
- Viteä»£ç†è½¬å‘åˆ°åç«¯

**ä¼˜ç‚¹ï¼š**
- å¼€å‘ç¯å¢ƒç»Ÿä¸€ç«¯å£
- æ— éœ€é…ç½®nginx

**ç¼ºç‚¹ï¼š**
- æ‰€æœ‰è¯·æ±‚ç»è¿‡Javaå¤„ç†ï¼Œæ€§èƒ½ä¸å¦‚nginx

---

## ğŸš€ å¿«é€Ÿä¿®å¤æ­¥éª¤

### å¦‚æœé€‰æ‹©nginxæ–¹æ¡ˆï¼ˆæ¨èï¼‰ï¼š

1. **ç¡®è®¤nginxé…ç½®å’Œå¯åŠ¨**
   ```bash
   nginx -t && nginx -s reload
   ```

2. **ç¡®è®¤æ–‡ä»¶åœ¨ code_deploy ç›®å½•**
   ```bash
   ls code_deploy/TelKgx/
   ```

3. **å‰ç«¯å·²ä¿®æ”¹**ï¼ˆåˆ·æ–°æµè§ˆå™¨ï¼‰
   - éƒ¨ç½²åä¼šè‡ªåŠ¨ä½¿ç”¨ `http://localhost/{deployKey}/`

4. **æµ‹è¯•è®¿é—®**
   ```
   http://localhost/TelKgx/
   ```

---

### å¦‚æœé€‰æ‹©åç«¯StaticResourceControllerï¼š

1. **ä¿®æ”¹åç«¯å¸¸é‡**
   ```java
   private static final String PREVIEW_ROOT_DIR = "code_deploy";
   ```

2. **æ·»åŠ è°ƒè¯•æ—¥å¿—**
   ```java
   System.out.println("è®¿é—®è·¯å¾„: " + deployKey + resourcePath);
   System.out.println("æ–‡ä»¶è·¯å¾„: " + filePath);
   System.out.println("æ–‡ä»¶å­˜åœ¨: " + file.exists());
   ```

3. **é‡å¯åç«¯**

4. **æµ‹è¯•è®¿é—®**
   ```
   http://localhost:8123/api/static/TelKgx/
   ```

---

## ğŸ“Š å½“å‰å‰ç«¯é…ç½®

å·²ä¿®æ”¹ä¸ºæ™ºèƒ½é€‰æ‹©ï¼š

```typescript
if (app?.deployedTime) {
  // å·²éƒ¨ç½² â†’ ä½¿ç”¨nginx
  previewUrl.value = `http://localhost/${deployKey}/`
} else {
  // å¼€å‘ä¸­ â†’ ä½¿ç”¨åç«¯Controller
  previewUrl.value = `/api/static/${deployKey}/`
}
```

**åˆ·æ–°æµè§ˆå™¨åæµ‹è¯•ï¼**

---

## ğŸ’¡ å»ºè®®

åŸºäºæ‚¨æåˆ°"nginxé…ç½®å·²å®Œæˆ"ï¼Œå»ºè®®ï¼š

1. âœ… **ä½¿ç”¨nginxæ–¹æ¡ˆ**ï¼ˆæ–¹æ¡ˆAï¼‰
2. âœ… ç¡®ä¿éƒ¨ç½²æœåŠ¡å°†æ–‡ä»¶å¤åˆ¶åˆ° `code_deploy/`
3. âœ… åˆ·æ–°å‰ç«¯æµè§ˆå™¨
4. âœ… é‡æ–°éƒ¨ç½²åº”ç”¨æµ‹è¯•

è¿™æ ·é¢„è§ˆä¼šç›´æ¥è®¿é—® `http://localhost/{deployKey}/`ï¼Œä¸ç»è¿‡åç«¯ï¼Œæ€§èƒ½æœ€å¥½ï¼

