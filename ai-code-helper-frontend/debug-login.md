# ç™»å½•é—®é¢˜è°ƒè¯•æŒ‡å—

## å½“å‰é”™è¯¯åˆ†æ

**é”™è¯¯ä¿¡æ¯ï¼š** `A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received`

**åŸå› åˆ†æï¼š**
1. è¿™ä¸ªé”™è¯¯é€šå¸¸ç”±**æµè§ˆå™¨æ‰©å±•**å¼•èµ·ï¼ˆå¦‚å¹¿å‘Šæ‹¦æˆªå™¨ã€éšç§ä¿æŠ¤æ’ä»¶ï¼‰
2. å¦‚æœ"åç«¯æ²¡æœ‰æ”¶åˆ°è¯·æ±‚"ï¼Œè¯´æ˜è¯·æ±‚åœ¨æµè§ˆå™¨ç«¯å°±è¢«æ‹¦æˆªäº†

---

## ğŸ” å¿«é€Ÿè¯Šæ–­æ­¥éª¤

### 1ï¸âƒ£ æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ

åœ¨å‘½ä»¤è¡Œè¿è¡Œï¼š
```bash
curl http://localhost:8123/api/user/list
```

**é¢„æœŸç»“æœï¼š** è¿”å›JSONæ ¼å¼çš„ç”¨æˆ·åˆ—è¡¨

**å¦‚æœå¤±è´¥ï¼š**
- æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨
- æ£€æŸ¥ç«¯å£æ˜¯å¦ä¸º8123
- æŸ¥çœ‹åç«¯æ§åˆ¶å°æ—¥å¿—

---

### 2ï¸âƒ£ ä½¿ç”¨æµ‹è¯•é¡µé¢

è®¿é—®ï¼š`http://localhost:5173/test-api.html`

ä¾æ¬¡ç‚¹å‡»3ä¸ªæµ‹è¯•æŒ‰é’®ï¼Œè®°å½•ç»“æœï¼š
- âœ… æµ‹è¯•1é€šè¿‡ â†’ CORSé…ç½®æ­£ç¡®
- âœ… æµ‹è¯•2é€šè¿‡ â†’ Viteä»£ç†å·¥ä½œæ­£å¸¸
- âœ… æµ‹è¯•3é€šè¿‡ â†’ ç™»å½•æ¥å£æ­£å¸¸

**å¦‚æœéƒ½é€šè¿‡ä½†Vueåº”ç”¨è¿˜æ˜¯æŠ¥é”™** â†’ æµè§ˆå™¨æ‰©å±•é—®é¢˜

---

### 3ï¸âƒ£ æ’é™¤æµè§ˆå™¨æ‰©å±•å¹²æ‰°

**æ–¹æ³•1ï¼šä½¿ç”¨æ— ç—•æ¨¡å¼**
- Chrome: `Ctrl + Shift + N`
- Firefox: `Ctrl + Shift + P`
- Edge: `Ctrl + Shift + N`

åœ¨æ— ç—•æ¨¡å¼è®¿é—®ï¼š`http://localhost:5173/login`

**æ–¹æ³•2ï¼šç¦ç”¨å¯ç–‘æ‰©å±•**

å¸¸è§å¹²æ‰°æ‰©å±•ï¼š
- âŒ AdBlock Plus / uBlock Originï¼ˆå¹¿å‘Šæ‹¦æˆªï¼‰
- âŒ Privacy Badgerï¼ˆéšç§ä¿æŠ¤ï¼‰
- âŒ Ghosteryï¼ˆè¿½è¸ªå™¨æ‹¦æˆªï¼‰
- âŒ æŸäº›VPNæ‰©å±•

ä¸´æ—¶ç¦ç”¨è¿™äº›æ‰©å±•åé‡è¯•ã€‚

---

### 4ï¸âƒ£ æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·

**æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼š**

#### Network æ ‡ç­¾
1. åˆ·æ–°ç™»å½•é¡µé¢
2. ç‚¹å‡»ç™»å½•æŒ‰é’®
3. æŸ¥çœ‹ `/api/user/login` è¯·æ±‚

**æ­£å¸¸æƒ…å†µåº”è¯¥çœ‹åˆ°ï¼š**
```
Request URL: http://localhost:5173/api/user/login
Request Method: POST
Status Code: 200
```

**å¦‚æœçœ‹åˆ°ï¼š**
- âŒ è¯·æ±‚è¢« `(canceled)` â†’ æµè§ˆå™¨æ‰©å±•æ‹¦æˆª
- âŒ è¯·æ±‚è¢« `(blocked:other)` â†’ å†…å®¹å®‰å…¨ç­–ç•¥é—®é¢˜
- âŒ `net::ERR_CONNECTION_REFUSED` â†’ åç«¯æœªå¯åŠ¨æˆ–ç«¯å£é”™è¯¯
- âŒ `CORS policy error` â†’ CORSé…ç½®é—®é¢˜

#### Console æ ‡ç­¾
æŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯ä¿¡æ¯ï¼š
- çº¢è‰²é”™è¯¯ä¿¡æ¯
- é»„è‰²è­¦å‘Šä¿¡æ¯

**é‡è¦ï¼š** æˆªå›¾å¹¶è®°å½•å®Œæ•´çš„é”™è¯¯å †æ ˆã€‚

---

## ğŸ”§ é’ˆå¯¹æ€§è§£å†³æ–¹æ¡ˆ

### æƒ…å†µA: åç«¯æœªæ”¶åˆ°è¯·æ±‚ + æµè§ˆå™¨æ‰©å±•é”™è¯¯

**è§£å†³æ–¹æ³•ï¼š**
```bash
# 1. ä½¿ç”¨æ— ç—•æ¨¡å¼
# 2. æˆ–ç¦ç”¨æ‰€æœ‰æ‰©å±•
# 3. æˆ–è€…åœ¨æ‰©å±•è®¾ç½®ä¸­æ·»åŠ  localhost:5173 åˆ°ç™½åå•
```

---

### æƒ…å†µB: CORSé”™è¯¯

**å‰ç«¯é…ç½®ï¼ˆå·²å®Œæˆï¼‰ï¼š**
- âœ… vite.config.ts ä»£ç†é…ç½®
- âœ… axios withCredentials: true

**åç«¯é…ç½®ï¼ˆéœ€è¦ç¡®è®¤ï¼‰ï¼š**

æ£€æŸ¥æ‚¨çš„ `CorsConfig.java` æ˜¯å¦ç”Ÿæ•ˆï¼š

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowCredentials(true)
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .exposedHeaders("*");
    }
}
```

**é¢å¤–æ£€æŸ¥ï¼š** ç¡®ä¿æ²¡æœ‰å…¶ä»–é…ç½®è¦†ç›–äº†CORSè®¾ç½®

---

### æƒ…å†µC: Sessioné—®é¢˜

å¦‚æœç™»å½•è¯·æ±‚å‘é€æˆåŠŸï¼Œä½†åç«¯è¯´"æœªç™»å½•"ï¼š

**åç«¯é…ç½®ï¼ˆapplication.ymlï¼‰ï¼š**
```yaml
server:
  port: 8123
  servlet:
    session:
      cookie:
        same-site: lax  # æˆ– noneï¼ˆéœ€è¦é…åˆsecure=trueï¼‰
        secure: false   # å¼€å‘ç¯å¢ƒç”¨false
        http-only: false
```

---

### æƒ…å†µD: è¯·æ±‚æ ¼å¼é”™è¯¯

**ç¡®è®¤è¯·æ±‚å‚æ•°æ ¼å¼ï¼š**

æ‰“å¼€ Network â†’ æ‰¾åˆ°ç™»å½•è¯·æ±‚ â†’ ç‚¹å‡» â†’ Payload

åº”è¯¥çœ‹åˆ°ï¼š
```json
{
  "userAccount": "ä½ çš„è´¦å·",
  "userPassword": "ä½ çš„å¯†ç "
}
```

**å¦‚æœæ ¼å¼ä¸å¯¹**ï¼Œè¯´æ˜å‰ç«¯ä»£ç æœ‰é—®é¢˜ã€‚

---

## ğŸ› å®Œæ•´è°ƒè¯•æµç¨‹

```mermaid
graph TD
    A[ç™»å½•å¤±è´¥] --> B{åç«¯æ”¶åˆ°è¯·æ±‚?}
    B -->|å¦| C{æµ‹è¯•é¡µé¢èƒ½è®¿é—®åç«¯?}
    C -->|æ˜¯| D[æµè§ˆå™¨æ‰©å±•æ‹¦æˆª]
    C -->|å¦| E[åç«¯æœªå¯åŠ¨æˆ–CORSé—®é¢˜]
    B -->|æ˜¯| F{è¿”å›ä»€ä¹ˆé”™è¯¯?}
    F -->|401| G[è´¦å·å¯†ç é”™è¯¯]
    F -->|500| H[åç«¯ä»£ç é”™è¯¯]
    F -->|403| I[CSRFæˆ–æƒé™é—®é¢˜]
```

### 1. åç«¯æ˜¯å¦æ”¶åˆ°è¯·æ±‚ï¼Ÿ

**æ£€æŸ¥æ–¹æ³•ï¼š** åœ¨åç«¯ `UserController.userLogin()` æ–¹æ³•å¼€å¤´æ·»åŠ æ—¥å¿—ï¼š
```java
@PostMapping("/login")
public BaseResponse<LoginUserVO> userLogin(@RequestBody UserLoginRequest userLoginRequest, HttpServletRequest request) {
    System.out.println("æ”¶åˆ°ç™»å½•è¯·æ±‚: " + userLoginRequest.getUserAccount());  // æ·»åŠ è¿™è¡Œ
    // ... åŸæœ‰ä»£ç 
}
```

é‡å¯åç«¯ï¼Œå†æ¬¡ç™»å½•ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ã€‚

**ç»“æœåˆ¤æ–­ï¼š**
- âœ… **æœ‰æ—¥å¿—** â†’ è¯·æ±‚åˆ°è¾¾ï¼Œæ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®
- âŒ **æ— æ—¥å¿—** â†’ è¯·æ±‚æœªåˆ°è¾¾ï¼Œç»§ç»­ä¸‹ä¸€æ­¥

---

### 2. æµ‹è¯•é¡µé¢èƒ½å¦è®¿é—®ï¼Ÿ

è®¿é—®ï¼š`http://localhost:5173/test-api.html`

ç‚¹å‡»"æµ‹è¯•åç«¯è¿æ¥"

**ç»“æœåˆ¤æ–­ï¼š**
- âœ… **æˆåŠŸ** â†’ åç«¯æ­£å¸¸ï¼Œä½†Vueåº”ç”¨è¢«æ‹¦æˆª â†’ **æµè§ˆå™¨æ‰©å±•é—®é¢˜**
- âŒ **å¤±è´¥** â†’ åç«¯é—®é¢˜æˆ–CORSé—®é¢˜

---

### 3. ä½¿ç”¨æ— ç—•æ¨¡å¼

åœ¨æ— ç—•æ¨¡å¼è®¿é—®ï¼š`http://localhost:5173/login`

**ç»“æœåˆ¤æ–­ï¼š**
- âœ… **æˆåŠŸ** â†’ **ç¡®è®¤æ˜¯æµè§ˆå™¨æ‰©å±•é—®é¢˜**
- âŒ **ä»å¤±è´¥** â†’ ç»§ç»­æ’æŸ¥

---

### 4. æ£€æŸ¥è¯·æ±‚è¯¦æƒ…

å¼€å‘è€…å·¥å…· â†’ Network â†’ æ‰¾åˆ°ç™»å½•è¯·æ±‚

**å…³é”®ä¿¡æ¯ï¼š**
1. Request URL: åº”è¯¥æ˜¯ `http://localhost:5173/api/user/login`
2. Request Headers: åº”è¯¥åŒ…å« `Content-Type: application/json`
3. Request Payload: åº”è¯¥æ˜¯ `{userAccount, userPassword}`
4. Response Status: æœŸæœ›æ˜¯ 200

---

## ğŸ“‹ åé¦ˆæ¸…å•

å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½å°è¯•è¿‡ä»ç„¶å¤±è´¥ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

- [ ] åç«¯å¯åŠ¨æ—¥å¿—ï¼ˆåŒ…å«ç«¯å£ä¿¡æ¯ï¼‰
- [ ] æµ‹è¯•é¡µé¢3ä¸ªæµ‹è¯•çš„ç»“æœæˆªå›¾
- [ ] æµè§ˆå™¨ Network æ ‡ç­¾çš„è¯·æ±‚è¯¦æƒ…æˆªå›¾
- [ ] æµè§ˆå™¨ Console æ ‡ç­¾çš„é”™è¯¯ä¿¡æ¯
- [ ] æ˜¯å¦ä½¿ç”¨äº†æ— ç—•æ¨¡å¼æµ‹è¯•
- [ ] ä½¿ç”¨çš„æµè§ˆå™¨åç§°å’Œç‰ˆæœ¬
- [ ] åç«¯æ˜¯å¦åœ¨æ—¥å¿—ä¸­çœ‹åˆ°è¯·æ±‚

---

## âœ… é¢„æœŸæ­£å¸¸æµç¨‹

### å‰ç«¯å‘é€ï¼š
```http
POST http://localhost:5173/api/user/login
Content-Type: application/json

{
  "userAccount": "test123",
  "userPassword": "12345678"
}
```

### Viteä»£ç†è½¬å‘ï¼š
```http
POST http://localhost:8123/api/user/login
Content-Type: application/json
Cookie: JSESSIONID=xxx

{
  "userAccount": "test123",
  "userPassword": "12345678"
}
```

### åç«¯å“åº”ï¼š
```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "id": 1,
    "userAccount": "test123",
    "userName": "æµ‹è¯•ç”¨æˆ·",
    "userRole": "user",
    ...
  }
}
```

### å‰ç«¯å¤„ç†ï¼š
- ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° localStorage
- è·³è½¬åˆ°é¦–é¡µ
- å¯¼èˆªæ æ˜¾ç¤ºç”¨æˆ·å

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•å‘½ä»¤

### åç«¯å¥åº·æ£€æŸ¥
```bash
# æµ‹è¯•åç«¯æ˜¯å¦è¿è¡Œ
curl http://localhost:8123/api/user/list

# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://localhost:8123/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"userAccount":"test123","userPassword":"12345678"}'
```

### å‰ç«¯å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥Viteæ˜¯å¦è¿è¡Œ
curl http://localhost:5173

# æ£€æŸ¥ä»£ç†æ˜¯å¦å·¥ä½œ
curl http://localhost:5173/api/user/list
```

---

## ğŸ’¡ æç¤º

1. **å…ˆç”¨æµ‹è¯•é¡µé¢ç¡®è®¤è¿é€šæ€§**
2. **å†ç”¨æ— ç—•æ¨¡å¼æ’é™¤æ‰©å±•å¹²æ‰°**
3. **æœ€åæ£€æŸ¥å…·ä½“çš„è¯·æ±‚å‚æ•°**

å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¿™ä¸ªé”™è¯¯éƒ½æ˜¯æµè§ˆå™¨æ‰©å±•å¼•èµ·çš„ï¼

