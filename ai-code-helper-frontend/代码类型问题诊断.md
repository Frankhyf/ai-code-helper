# ä»£ç ç±»å‹é—®é¢˜è¯Šæ–­æŒ‡å—

## ğŸ› é—®é¢˜æè¿°

å‰ç«¯é€‰æ‹©"å•æ–‡ä»¶HTML"ï¼Œä½†åç«¯è¿˜æ˜¯ç”Ÿæˆäº† `multi_file_345576892788633600`

---

## ğŸ” é—®é¢˜æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šç¡®è®¤å‰ç«¯æ˜¯å¦å‘é€äº†æ­£ç¡®çš„å‚æ•°

**æ‰“å¼€æµè§ˆå™¨ Consoleï¼Œåˆ›å»ºåº”ç”¨æ—¶æŸ¥çœ‹æ—¥å¿—ï¼š**

åº”è¯¥çœ‹åˆ°ï¼š
```
åˆ›å»ºåº”ç”¨è¯·æ±‚å‚æ•°: {initPrompt: "...", codeGenType: "html"}
```

**å¦‚æœçœ‹åˆ° `codeGenType: "html"`ï¼Œè¯´æ˜å‰ç«¯æ­£ç¡®å‘é€äº†ã€‚**

**æ‰“å¼€ Network æ ‡ç­¾ï¼ŒæŸ¥çœ‹ `/api/app/add` è¯·æ±‚ï¼š**

Payload åº”è¯¥æ˜¯ï¼š
```json
{
  "initPrompt": "åˆ›å»ºä¸€ä¸ªä¸ªäººåšå®¢",
  "codeGenType": "html"
}
```

âœ… **å¦‚æœå‰ç«¯å‘é€æ­£ç¡®ï¼Œé—®é¢˜åœ¨åç«¯ã€‚**

---

### æ­¥éª¤2ï¼šæ£€æŸ¥åç«¯ AppAddRequest æ˜¯å¦æ¥æ”¶å‚æ•°

**æ‰“å¼€åç«¯ä»£ç ï¼š`AppAddRequest.java`**

```java
@Data
public class AppAddRequest {
    private String initPrompt;
    private String codeGenType;  // â† å¿…é¡»æœ‰è¿™ä¸ªå­—æ®µï¼
}
```

**å¦‚æœæ²¡æœ‰ `codeGenType` å­—æ®µï¼Œæ·»åŠ å®ƒï¼š**

```java
@Data
public class AppAddRequest implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * åº”ç”¨åˆå§‹æç¤ºè¯
     */
    private String initPrompt;
    
    /**
     * ä»£ç ç”Ÿæˆç±»å‹ï¼šhtml(å•æ–‡ä»¶) æˆ– multi_file(å¤šæ–‡ä»¶)
     */
    private String codeGenType;
}
```

---

### æ­¥éª¤3ï¼šæ£€æŸ¥ AppService æ˜¯å¦ä½¿ç”¨äº† codeGenType

**æ‰“å¼€åç«¯ä»£ç ï¼š`AppServiceImpl.java` æˆ– `AppService.java`**

**æŸ¥æ‰¾ `createApp` æ–¹æ³•ï¼š**

```java
@Override
public Long createApp(AppAddRequest appAddRequest, User loginUser) {
    String initPrompt = appAddRequest.getInitPrompt();
    String codeGenType = appAddRequest.getCodeGenType();  // â† å¿…é¡»è·å–è¿™ä¸ªå‚æ•°
    
    // æ·»åŠ æ—¥å¿—æŸ¥çœ‹
    System.out.println("=== åˆ›å»ºåº”ç”¨ ===");
    System.out.println("initPrompt: " + initPrompt);
    System.out.println("codeGenType: " + codeGenType);  // â† æ·»åŠ è¿™è¡Œæ—¥å¿—
    
    // é»˜è®¤å€¼å¤„ç†
    if (StrUtil.isBlank(codeGenType)) {
        codeGenType = "html";  // å¦‚æœå‰ç«¯æ²¡ä¼ ï¼Œé»˜è®¤å•æ–‡ä»¶
        System.out.println("codeGenTypeä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼: html");
    }
    
    // åˆ›å»ºåº”ç”¨å¯¹è±¡
    App app = new App();
    app.setInitPrompt(initPrompt);
    app.setCodeGenType(codeGenType);  // â† å¿…é¡»è®¾ç½®è¿™ä¸ªå­—æ®µ
    app.setUserId(loginUser.getId());
    app.setAppName("AIç”Ÿæˆåº”ç”¨-" + System.currentTimeMillis());
    // ... å…¶ä»–å­—æ®µ
    
    this.save(app);
    
    System.out.println("åº”ç”¨åˆ›å»ºæˆåŠŸï¼ŒID: " + app.getId() + ", codeGenType: " + app.getCodeGenType());
    System.out.println("==================");
    
    return app.getId();
}
```

---

### æ­¥éª¤4ï¼šæ£€æŸ¥ AI ç”Ÿæˆä»£ç æ—¶æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„ç±»å‹

**æŸ¥æ‰¾ç”Ÿæˆä»£ç çš„æ–¹æ³•ï¼ˆå¯èƒ½åœ¨ AppService æˆ– AIService ä¸­ï¼‰ï¼š**

```java
public Flux<String> chatToGenCode(Long appId, String message, User loginUser) {
    // 1. è·å–åº”ç”¨ä¿¡æ¯
    App app = this.getById(appId);
    ThrowUtils.throwIf(app == null, ErrorCode.NOT_FOUND_ERROR);
    
    // 2. è·å–ä»£ç ç”Ÿæˆç±»å‹
    String codeGenType = app.getCodeGenType();
    System.out.println("AIç”Ÿæˆä»£ç ï¼ŒappId: " + appId + ", codeGenType: " + codeGenType);
    
    // 3. æ ¹æ®ç±»å‹ç”Ÿæˆä¸åŒçš„æç¤ºè¯
    String systemPrompt;
    if ("html".equals(codeGenType)) {
        systemPrompt = "è¯·ç”Ÿæˆå•æ–‡ä»¶HTMLä»£ç ï¼Œæ‰€æœ‰CSSå’ŒJSéƒ½å†…åµŒåœ¨HTMLä¸­...";
    } else {
        systemPrompt = "è¯·ç”Ÿæˆå¤šæ–‡ä»¶é¡¹ç›®ï¼ŒåŒ…å«HTMLã€CSSã€JSç­‰åˆ†ç¦»çš„æ–‡ä»¶...";
    }
    
    // 4. è°ƒç”¨ AI ç”Ÿæˆ
    // ...
}
```

---

## ğŸ¯ å®Œæ•´çš„åç«¯ä»£ç ç¤ºä¾‹

### AppAddRequest.java

```java
package com.frank.aicodehelper.model.dto.app;

import lombok.Data;
import java.io.Serializable;

@Data
public class AppAddRequest implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * åº”ç”¨åˆå§‹æç¤ºè¯
     */
    private String initPrompt;
    
    /**
     * ä»£ç ç”Ÿæˆç±»å‹ï¼šhtml(å•æ–‡ä»¶) æˆ– multi_file(å¤šæ–‡ä»¶)
     * é»˜è®¤ä¸º html
     */
    private String codeGenType;
}
```

### AppServiceImpl.java (createAppæ–¹æ³•)

```java
@Override
public Long createApp(AppAddRequest appAddRequest, User loginUser) {
    // 1. å‚æ•°æ ¡éªŒ
    ThrowUtils.throwIf(appAddRequest == null, ErrorCode.PARAMS_ERROR);
    String initPrompt = appAddRequest.getInitPrompt();
    ThrowUtils.throwIf(StrUtil.isBlank(initPrompt), ErrorCode.PARAMS_ERROR, "æç¤ºè¯ä¸èƒ½ä¸ºç©º");
    
    // 2. è·å–ä»£ç ç”Ÿæˆç±»å‹ï¼ˆé‡è¦ï¼ï¼‰
    String codeGenType = appAddRequest.getCodeGenType();
    if (StrUtil.isBlank(codeGenType)) {
        codeGenType = "html";  // é»˜è®¤å•æ–‡ä»¶
    }
    
    // 3. æ—¥å¿—è¾“å‡ºï¼ˆè°ƒè¯•ç”¨ï¼‰
    log.info("åˆ›å»ºåº”ç”¨ - æç¤ºè¯: {}, ä»£ç ç±»å‹: {}", initPrompt, codeGenType);
    
    // 4. åˆ›å»ºåº”ç”¨
    App app = new App();
    app.setInitPrompt(initPrompt);
    app.setCodeGenType(codeGenType);  // è®¾ç½®ä»£ç ç±»å‹
    app.setUserId(loginUser.getId());
    app.setAppName("AIåº”ç”¨-" + System.currentTimeMillis());
    app.setCreateTime(LocalDateTime.now());
    app.setUpdateTime(LocalDateTime.now());
    
    // 5. ä¿å­˜åˆ°æ•°æ®åº“
    boolean saved = this.save(app);
    ThrowUtils.throwIf(!saved, ErrorCode.OPERATION_ERROR, "åˆ›å»ºåº”ç”¨å¤±è´¥");
    
    log.info("åº”ç”¨åˆ›å»ºæˆåŠŸ - ID: {}, ä»£ç ç±»å‹: {}", app.getId(), app.getCodeGenType());
    
    return app.getId();
}
```

### AppServiceImpl.java (chatToGenCodeæ–¹æ³•)

```java
@Override
public Flux<String> chatToGenCode(Long appId, String message, User loginUser) {
    // 1. è·å–åº”ç”¨
    App app = this.getById(appId);
    ThrowUtils.throwIf(app == null, ErrorCode.NOT_FOUND_ERROR, "åº”ç”¨ä¸å­˜åœ¨");
    
    // 2. æƒé™æ£€æŸ¥
    if (!app.getUserId().equals(loginUser.getId())) {
        throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
    }
    
    // 3. è·å–ä»£ç ç”Ÿæˆç±»å‹ï¼ˆå…³é”®ï¼ï¼‰
    String codeGenType = app.getCodeGenType();
    if (StrUtil.isBlank(codeGenType)) {
        codeGenType = "html";  // å…œåº•é»˜è®¤å€¼
    }
    
    log.info("AIå¯¹è¯ç”Ÿæˆä»£ç  - appId: {}, codeGenType: {}, message: {}", 
             appId, codeGenType, message);
    
    // 4. æ ¹æ®ç±»å‹æ„å»ºä¸åŒçš„ç³»ç»Ÿæç¤ºè¯
    String systemPrompt = buildSystemPrompt(codeGenType);
    
    // 5. è°ƒç”¨ AI æœåŠ¡
    Flux<String> aiResponse = aiService.chat(systemPrompt, message, app.getInitPrompt());
    
    // 6. ä¿å­˜ç”Ÿæˆçš„ä»£ç åˆ°æ–‡ä»¶
    return aiResponse.doOnNext(chunk -> {
        // ä¿å­˜ä»£ç ç‰‡æ®µ
        saveCodeChunk(appId, codeGenType, chunk);
    });
}

/**
 * æ ¹æ®ä»£ç ç±»å‹æ„å»ºç³»ç»Ÿæç¤ºè¯
 */
private String buildSystemPrompt(String codeGenType) {
    if ("html".equals(codeGenType)) {
        return "ä½ æ˜¯ä¸€ä¸ªå‰ç«¯å¼€å‘ä¸“å®¶ã€‚è¯·ç”Ÿæˆ**å•æ–‡ä»¶HTML**ä»£ç ï¼Œè¦æ±‚ï¼š\n" +
               "1. æ‰€æœ‰CSSæ ·å¼å¿…é¡»å†™åœ¨<style>æ ‡ç­¾å†…\n" +
               "2. æ‰€æœ‰JavaScriptä»£ç å¿…é¡»å†™åœ¨<script>æ ‡ç­¾å†…\n" +
               "3. ä¸è¦å¼•ç”¨å¤–éƒ¨CSSæˆ–JSæ–‡ä»¶\n" +
               "4. ç”Ÿæˆå®Œæ•´çš„HTMLæ–‡æ¡£ï¼ŒåŒ…å«<!DOCTYPE html>\n" +
               "5. ä»£ç è¦ç°ä»£åŒ–ã€å“åº”å¼ã€ç¾è§‚\n" +
               "ç›´æ¥è¾“å‡ºHTMLä»£ç ï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šã€‚";
    } else {
        return "ä½ æ˜¯ä¸€ä¸ªå‰ç«¯å¼€å‘ä¸“å®¶ã€‚è¯·ç”Ÿæˆ**å¤šæ–‡ä»¶é¡¹ç›®**ï¼Œè¦æ±‚ï¼š\n" +
               "1. HTMLã€CSSã€JSåˆ†ç¦»\n" +
               "2. ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¼•ç”¨èµ„æº\n" +
               "3. æ–‡ä»¶ç»“æ„æ¸…æ™°\n" +
               "4. ä»£ç è¦ç°ä»£åŒ–ã€å“åº”å¼ã€ç¾è§‚\n" +
               "è¾“å‡ºæ ¼å¼ï¼š\n" +
               "===FILE: index.html===\n" +
               "[HTMLä»£ç ]\n" +
               "===FILE: style.css===\n" +
               "[CSSä»£ç ]\n" +
               "===FILE: script.js===\n" +
               "[JSä»£ç ]";
    }
}

/**
 * ä¿å­˜ä»£ç ç‰‡æ®µåˆ°æ–‡ä»¶
 */
private void saveCodeChunk(Long appId, String codeGenType, String chunk) {
    // æ„å»ºè¾“å‡ºç›®å½•
    String outputDir = AppConstant.CODE_OUTPUT_ROOT_DIR + "/" + 
                       codeGenType + "_" + appId;
    
    // ç¡®ä¿ç›®å½•å­˜åœ¨
    File dir = new File(outputDir);
    if (!dir.exists()) {
        dir.mkdirs();
    }
    
    // è¿½åŠ å†™å…¥æ–‡ä»¶
    // ... å…·ä½“å®ç°
}
```

---

## ğŸ“‹ éªŒè¯æ¸…å•

### å‰ç«¯éªŒè¯ï¼ˆæµè§ˆå™¨Consoleï¼‰
- [ ] Consoleæ˜¾ç¤º: `åˆ›å»ºåº”ç”¨è¯·æ±‚å‚æ•°: {initPrompt: "...", codeGenType: "html"}`
- [ ] Networkæ ‡ç­¾PayloadåŒ…å«: `"codeGenType": "html"`

### åç«¯éªŒè¯ï¼ˆåç«¯æ—¥å¿—ï¼‰
- [ ] Controlleræ¥æ”¶åˆ°å‚æ•°: `codeGenType: html`
- [ ] Serviceåˆ›å»ºåº”ç”¨ä½¿ç”¨äº†å‚æ•°: `è®¾ç½®codeGenType: html`
- [ ] ç”Ÿæˆä»£ç æ—¶ä½¿ç”¨äº†æ­£ç¡®ç±»å‹: `AIç”Ÿæˆä»£ç ï¼ŒcodeGenType: html`
- [ ] æ–‡ä»¶ä¿å­˜è·¯å¾„æ­£ç¡®: `tmp/code_output/html_345576892788633600/`

### æ•°æ®åº“éªŒè¯
```sql
SELECT id, app_name, code_gen_type, init_prompt 
FROM app 
WHERE id = 345576892788633600;

-- code_gen_type åº”è¯¥æ˜¯ 'html' è€Œä¸æ˜¯ 'multi_file'
```

### æ–‡ä»¶ç³»ç»ŸéªŒè¯
```bash
# æ£€æŸ¥ç”Ÿæˆçš„ç›®å½•å
ls tmp/code_output/

# åº”è¯¥çœ‹åˆ° html_345576892788633600 è€Œä¸æ˜¯ multi_file_345576892788633600
```

---

## ğŸš€ å¿«é€Ÿä¿®å¤æ­¥éª¤

1. **ä¿®æ”¹ AppAddRequest**ï¼ˆæ·»åŠ  codeGenType å­—æ®µï¼‰
2. **ä¿®æ”¹ AppService.createApp**ï¼ˆä½¿ç”¨ codeGenType å‚æ•°ï¼‰
3. **ä¿®æ”¹ AppService.chatToGenCode**ï¼ˆæ ¹æ® codeGenType ç”Ÿæˆä¸åŒä»£ç ï¼‰
4. **æ·»åŠ æ—¥å¿—**ï¼ˆç¡®è®¤æ¯ä¸ªç¯èŠ‚éƒ½ä½¿ç”¨äº†æ­£ç¡®çš„ç±»å‹ï¼‰
5. **é‡å¯åç«¯**
6. **åˆ·æ–°å‰ç«¯**
7. **é‡æ–°åˆ›å»ºåº”ç”¨æµ‹è¯•**

---

## ğŸ” è°ƒè¯•æŠ€å·§

### åœ¨ Controller æ·»åŠ è°ƒè¯•æ—¥å¿—

```java
@PostMapping("/add")
public BaseResponse<Long> addApp(@RequestBody AppAddRequest appAddRequest, HttpServletRequest request) {
    // æ‰“å°æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•°
    System.out.println("=== Controlleræ¥æ”¶å‚æ•° ===");
    System.out.println("AppAddRequest: " + JSON.toJSONString(appAddRequest));
    System.out.println("initPrompt: " + appAddRequest.getInitPrompt());
    System.out.println("codeGenType: " + appAddRequest.getCodeGenType());
    System.out.println("========================");
    
    // ... åŸæœ‰ä»£ç 
}
```

### åœ¨ Service æ·»åŠ è°ƒè¯•æ—¥å¿—

```java
public Long createApp(AppAddRequest appAddRequest, User loginUser) {
    System.out.println("=== Serviceå¼€å§‹åˆ›å»ºåº”ç”¨ ===");
    System.out.println("codeGenTypeå‚æ•°: " + appAddRequest.getCodeGenType());
    
    App app = new App();
    app.setCodeGenType(appAddRequest.getCodeGenType());
    
    System.out.println("è®¾ç½®åˆ°Appå¯¹è±¡çš„codeGenType: " + app.getCodeGenType());
    
    this.save(app);
    
    System.out.println("ä¿å­˜åçš„Appå¯¹è±¡: " + JSON.toJSONString(app));
    System.out.println("========================");
    
    return app.getId();
}
```

---

## âœ¨ é¢„æœŸç»“æœ

ä¿®å¤åï¼Œåˆ›å»ºå•æ–‡ä»¶HTMLåº”ç”¨æ—¶ï¼š

**å‰ç«¯æ—¥å¿—ï¼š**
```
åˆ›å»ºåº”ç”¨è¯·æ±‚å‚æ•°: {initPrompt: "...", codeGenType: "html"}
```

**åç«¯æ—¥å¿—ï¼š**
```
=== Controlleræ¥æ”¶å‚æ•° ===
codeGenType: html
========================
=== Serviceå¼€å§‹åˆ›å»ºåº”ç”¨ ===
è®¾ç½®åˆ°Appå¯¹è±¡çš„codeGenType: html
========================
```

**æ–‡ä»¶ç³»ç»Ÿï¼š**
```
tmp/code_output/html_345576892788633600/index.html
```

**è€Œä¸æ˜¯ï¼š**
```
tmp/code_output/multi_file_345576892788633600/
```

---

å®Œæˆè¿™äº›ä¿®æ”¹åï¼Œå•æ–‡ä»¶HTMLåº”è¯¥å°±èƒ½æ­£å¸¸ç”Ÿæˆäº†ï¼

