# 使用说明：预览功能和代码类型设置

## ✅ 已修复的问题

### 1. 代码生成类型问题

**修改内容：**
前端现在会发送 `codeGenType` 参数给后端：
- `single` → `codeGenType: 'html'` （单文件HTML）
- `multiple` → `codeGenType: 'multi_file'` （多文件项目）

**后端需要验证：**
检查您的 `AppAddRequest` 是否接收 `codeGenType` 参数：

```java
public class AppAddRequest {
    private String initPrompt;
    private String codeGenType;  // ← 需要这个字段
    
    // getters and setters
}
```

**如果没有这个字段，请添加：**

```java
@Data
public class AppAddRequest {
    /**
     * 应用初始提示词
     */
    private String initPrompt;
    
    /**
     * 代码生成类型：html(单文件) 或 multi_file(多文件)
     */
    private String codeGenType;
}
```

**然后在 Service 中使用：**

```java
@Override
public Long createApp(AppAddRequest appAddRequest, User loginUser) {
    String initPrompt = appAddRequest.getInitPrompt();
    String codeGenType = appAddRequest.getCodeGenType();
    
    // 默认值处理
    if (StrUtil.isBlank(codeGenType)) {
        codeGenType = "html";  // 默认单文件
    }
    
    // 创建应用
    App app = new App();
    app.setInitPrompt(initPrompt);
    app.setCodeGenType(codeGenType);  // 设置代码类型
    app.setUserId(loginUser.getId());
    // ... 其他字段
    
    this.save(app);
    return app.getId();
}
```

---

### 2. 预览功能使用说明

**重要：预览功能需要先部署应用！**

#### 完整流程：

```
1. 创建应用 
   ↓
2. 与AI对话生成代码
   ↓
3. 代码生成完毕（显示"代码生成完成！点击'部署应用'查看效果"）
   ↓
4. 点击"部署应用"按钮 ⭐ 重要步骤
   ↓
5. 部署成功后，右侧iframe自动显示预览
   ↓
6. 点击"预览"按钮可在新窗口打开
```

#### 为什么必须先部署？

- **生成代码** → 代码保存在后端的临时目录 `tmp/code_output/{type}_{appId}/`
- **部署应用** → 后端将代码复制到静态资源目录，生成访问URL
- **预览应用** → 访问部署后的静态资源URL

**部署前：** 代码文件存在但无法通过Web访问
**部署后：** 代码可通过 `http://localhost:8123/api/static/html_{appId}/` 访问

---

## 🎯 正确的使用流程

### 步骤1：创建应用（选择类型）

在首页：
1. 输入应用描述
2. **选择类型**：
   - ✅ **单文件HTML** （推荐，快速生成，适合简单页面）
   - 📦 **多文件项目** （复杂项目，包含多个HTML/CSS/JS文件）
3. 点击"生成应用"

**前端发送：**
```json
{
  "initPrompt": "创建一个个人博客",
  "codeGenType": "html"  // 或 "multi_file"
}
```

---

### 步骤2：与AI对话生成代码

进入Chat页面后：

1. **发送消息**：
   ```
   请生成这个博客网站的HTML代码，包含：
   1. 导航栏
   2. 文章列表
   3. 侧边栏
   4. 底部版权信息
   ```

2. **观察流式输出**：
   - 左侧会实时显示AI生成的代码
   - 进度条显示生成进度
   - 代码保存在后端 `tmp/code_output/html_{appId}/index.html`

3. **等待完成**：
   - 显示"代码生成完成！点击'部署应用'查看效果"

---

### 步骤3：部署应用 ⭐

**这是查看预览的必要步骤！**

1. **点击顶部的"部署应用"按钮**
2. **显示"正在部署..."**
3. **后端执行**：
   - 创建部署目录（如果是多文件）
   - 复制代码文件到静态资源目录
   - 返回访问URL：`http://localhost:8123/api/static/html_{appId}/index.html`

4. **部署成功后**：
   - 显示"部署成功"
   - 右侧iframe自动加载预览
   - 应用状态变为"已部署"

---

### 步骤4：查看预览

**方式A：iframe预览（自动）**
- 部署成功后右侧自动显示

**方式B：新窗口预览**
1. 点击"预览"按钮
2. 在新标签页打开应用

**方式C：直接访问URL**
```
http://localhost:8123/api/static/html_{appId}/index.html
```

---

## 🔍 常见问题

### Q1: 点击预览显示"请先点击部署应用按钮"

**原因：** 代码生成了但还没部署

**解决：** 点击顶部的"部署应用"按钮

---

### Q2: 生成的是多文件代码，但我要单文件

**原因：** 创建应用时选择了错误的类型，或者后端没有接收到 `codeGenType` 参数

**解决方案：**

**立即解决：**
1. 删除当前应用
2. 重新创建，**确保选择"单文件HTML"**

**后端检查：**
```java
// 检查 AppAddRequest
@Data
public class AppAddRequest {
    private String initPrompt;
    private String codeGenType;  // ← 是否有这个字段？
}

// 检查 Service
App app = new App();
app.setCodeGenType(appAddRequest.getCodeGenType());  // ← 是否设置了？
```

---

### Q3: 部署后右侧预览是空白

**可能原因：**

**A. 生成的HTML有错误**
- 打开浏览器Console查看错误
- 检查生成的代码是否完整

**B. 静态资源路径问题**
- 检查后端静态资源Controller配置
- 检查文件是否确实被复制到部署目录

**C. CORS或CSP问题**
- 检查浏览器Console的网络错误
- 确认后端CORS配置正确

**调试方法：**
```bash
# 检查部署目录是否有文件
ls tmp/code_output/html_{appId}/

# 直接浏览器访问
http://localhost:8123/api/static/html_{appId}/index.html
```

---

### Q4: 如何验证后端是否接收到 codeGenType？

**方法1：后端日志**

在Controller添加日志：
```java
@PostMapping("/add")
public BaseResponse<Long> addApp(@RequestBody AppAddRequest appAddRequest, HttpServletRequest request) {
    System.out.println("接收到请求参数：");
    System.out.println("initPrompt: " + appAddRequest.getInitPrompt());
    System.out.println("codeGenType: " + appAddRequest.getCodeGenType());  // ← 打印这个
    // ...
}
```

**方法2：前端Console**

查看前端日志：
```
创建应用请求参数: {initPrompt: "...", codeGenType: "html"}
```

**方法3：Network标签**

查看请求Payload：
```json
{
  "initPrompt": "创建一个个人博客",
  "codeGenType": "html"
}
```

---

## 📊 前后端数据流

### 创建应用流程

```
Frontend                           Backend
   |                                  |
   | POST /app/add                    |
   | {initPrompt, codeGenType}        |
   |--------------------------------->|
   |                                  | 1. 创建App记录
   |                                  | 2. 设置codeGenType
   |                                  | 3. 保存到数据库
   |                                  |
   | {code:0, data:"appId"}           |
   |<---------------------------------|
   |                                  |
```

### AI对话生成流程

```
Frontend                           Backend
   |                                  |
   | GET /app/chat/gen/code           |
   | ?appId=xxx&message=xxx           |
   |--------------------------------->|
   |                                  | 1. 查询App记录
   |                                  | 2. 获取codeGenType
   |                                  | 3. 调用AI生成代码
   | SSE: {"d":"代码片段"}             |  4. 保存到临时目录
   |<-------------------------------- |     tmp/code_output/
   |                                  |     {codeGenType}_{appId}/
   | event:done                       |
   |<---------------------------------|
```

### 部署应用流程

```
Frontend                           Backend
   |                                  |
   | POST /app/deploy                 |
   | {appId: xxx}                     |
   |--------------------------------->|
   |                                  | 1. 查询App记录
   |                                  | 2. 复制代码文件
   |                                  |    tmp/ → static/
   |                                  | 3. 生成deployKey
   |                                  | 4. 更新数据库
   | {code:0,                         |
   |  data:"http://.../static/xxx"}   |
   |<---------------------------------|
   |                                  |
   | 更新previewUrl                   |
   | 加载iframe预览                    |
```

---

## ✨ 最佳实践

### 1. 单文件 vs 多文件选择

**单文件HTML（推荐新手）：**
- ✅ 生成快速
- ✅ 结构简单
- ✅ 适合：落地页、简单展示页、单页应用
- ❌ 代码全在一个文件，较长时不易维护

**多文件项目（适合复杂应用）：**
- ✅ 结构清晰
- ✅ 代码分离（HTML/CSS/JS）
- ✅ 适合：多页网站、复杂应用
- ❌ 生成时间较长
- ❌ 文件管理复杂

### 2. 提示词建议

**好的提示词：**
```
创建一个现代化的个人博客网站，使用单文件HTML格式，包含：
1. 响应式导航栏，带Logo和菜单
2. Hero区域，展示博客标题和简介
3. 文章列表，使用卡片布局，每篇文章显示标题、摘要、日期
4. 侧边栏，包含分类列表和标签云
5. 底部版权信息
使用现代CSS样式，深色主题，渐变背景
```

**避免的提示词：**
```
做个博客  ← 太简单
```

### 3. 迭代优化

**首次生成：** 生成基础功能
**第二轮：** "请添加搜索功能"
**第三轮：** "请优化移动端显示"
**第四轮：** "请添加深色模式切换"

每次对话后都可以部署查看效果！

---

## 🚀 快速测试清单

- [ ] 创建应用时选择了"单文件HTML"
- [ ] 前端Console显示 `codeGenType: "html"`
- [ ] 后端日志显示接收到 `codeGenType` 参数
- [ ] AI生成代码完成
- [ ] 点击"部署应用"按钮
- [ ] 显示"部署成功"
- [ ] 右侧iframe显示预览
- [ ] 点击"预览"按钮可在新窗口打开
- [ ] 生成的文件类型正确（单文件 = 一个HTML文件）

---

## 📞 问题反馈

如果仍有问题，请提供：

1. **前端Console完整日志**（特别是创建应用和部署的日志）
2. **后端日志**（Controller和Service的日志）
3. **Network标签**的请求详情
4. **文件系统检查**：`ls tmp/code_output/` 的输出

这样我能更准确地帮您解决问题！

