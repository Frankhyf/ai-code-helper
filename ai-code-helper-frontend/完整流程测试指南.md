# AIåº”ç”¨ç”Ÿæˆå¹³å° - å®Œæ•´æµç¨‹æµ‹è¯•æŒ‡å—

## âœ… å‰åç«¯å¯¹æ¥éªŒè¯

### APIå¯¹æ¥çŠ¶æ€æ£€æŸ¥

| åŠŸèƒ½ | åç«¯æ¥å£ | å‰ç«¯å®ç° | çŠ¶æ€ |
|------|---------|----------|------|
| åˆ›å»ºåº”ç”¨ | `POST /app/add` | âœ… ä»…å‘é€ `{initPrompt}` | âœ… æ­£ç¡® |
| AIå¯¹è¯ç”Ÿæˆ | `GET /app/chat/gen/code` | âœ… SSEæµå¼æ¥æ”¶ `{"d":"..."}` | âœ… æ­£ç¡® |
| éƒ¨ç½²åº”ç”¨ | `POST /app/deploy` | âœ… å‘é€ `{appId}` | âœ… æ­£ç¡® |
| è·å–è¯¦æƒ… | `GET /app/get/vo?id=` | âœ… å¸¦é‡è¯•æœºåˆ¶ | âœ… æ­£ç¡® |

---

## ğŸ¯ å®Œæ•´ç”¨æˆ·æµç¨‹

### æµç¨‹1: åˆ›å»ºåº”ç”¨

**ç”¨æˆ·æ“ä½œï¼š**
1. è®¿é—®é¦–é¡µ `http://localhost:5174/`
2. åœ¨è¾“å…¥æ¡†è¾“å…¥åº”ç”¨æè¿°
3. ç‚¹å‡»"ç”Ÿæˆåº”ç”¨"æŒ‰é’®

**å‰ç«¯å¤„ç†ï¼š**
```typescript
// Home.vue
const form: AppCreateForm = {
  name: `AIç”Ÿæˆåº”ç”¨ - ${new Date().toLocaleString()}`,
  description: appDescription.value.slice(0, 100) + '...',
  type: appType.value,  // 'single' æˆ– 'multiple'
  prompt: appDescription.value
}

// app.ts
await http.post('/app/add', {
  initPrompt: form.prompt  // åªå‘é€ initPrompt
})
```

**åç«¯å¤„ç†ï¼š**
```java
@PostMapping("/add")
public BaseResponse<Long> addApp(@RequestBody AppAddRequest appAddRequest, HttpServletRequest request) {
    User loginUser = userService.getLoginUser(request);
    Long appId = appService.createApp(appAddRequest, loginUser);
    return ResultUtils.success(appId);  // è¿”å›åº”ç”¨ID
}
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ˜¾ç¤º"åº”ç”¨åˆ›å»ºæˆåŠŸ"
- âœ… è‡ªåŠ¨è·³è½¬åˆ° `/app/chat/{appId}`
- âœ… æ§åˆ¶å°æ˜¾ç¤ºï¼š`åˆ›å»ºåº”ç”¨å“åº”: 345567246724042752 ç±»å‹: number`

---

### æµç¨‹2: AIå¯¹è¯ç”Ÿæˆä»£ç 

**ç”¨æˆ·æ“ä½œï¼š**
1. åœ¨å¯¹è¯é¡µé¢çš„è¾“å…¥æ¡†è¾“å…¥éœ€æ±‚ï¼ˆå¦‚ï¼š"æ·»åŠ ä¸€ä¸ªæ ‡é¢˜"ï¼‰
2. ç‚¹å‡»å‘é€æŒ‰é’®

**å‰ç«¯å¤„ç†ï¼š**
```typescript
// app.ts - chatWithAI()
const source = http.sse(
  `/app/chat/gen/code?appId=${appId}&message=${encodeURIComponent(prompt)}`,
  (payload) => {
    // æ¥æ”¶æ¯ä¸ªæ•°æ®å—
    const chunk = typeof payload === 'string' ? payload : payload?.d ?? ''
    aiContent += chunk
    // å®æ—¶æ›´æ–°UI
  },
  (error) => {
    // é”™è¯¯å¤„ç†
  },
  () => {
    // å®Œæˆå›è°ƒ
  }
)
```

**åç«¯å¤„ç†ï¼š**
```java
@GetMapping(value = "/chat/gen/code", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<ServerSentEvent<String>> chatToGenCode(
    @RequestParam Long appId,
    @RequestParam String message,
    HttpServletRequest request) {
    
    Flux<String> contentFlux = appService.chatToGenCode(appId, message, loginUser);
    
    return contentFlux
        .map(chunk -> {
            // åŒ…è£…ä¸º {"d": "å†…å®¹"}
            Map<String, String> wrapper = Map.of("d", chunk);
            String jsonData = JSONUtil.toJsonStr(wrapper);
            return ServerSentEvent.<String>builder()
                    .data(jsonData)
                    .build();
        })
        .concatWith(Mono.just(
            // ç»“æŸäº‹ä»¶
            ServerSentEvent.<String>builder()
                    .event("done")
                    .data("")
                    .build()
        ));
}
```

**SSEæ•°æ®æµæ ¼å¼ï¼š**
```
data: {"d":"<!DOCTYPE html>"}

data: {"d":"<html>"}

data: {"d":"<head>"}

...

event: done
data: 

```

**é¢„æœŸç»“æœï¼š**
- âœ… å·¦ä¾§æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
- âœ… AIå›å¤é€å­—æ˜¾ç¤ºï¼ˆæµå¼è¾“å‡ºï¼‰
- âœ… è¿›åº¦æ¡é€’å¢æ˜¾ç¤º
- âœ… å®Œæˆåæ˜¾ç¤º"ç”Ÿæˆå®Œæˆ"

---

### æµç¨‹3: éƒ¨ç½²åº”ç”¨

**ç”¨æˆ·æ“ä½œï¼š**
1. åœ¨å¯¹è¯é¡µé¢ç‚¹å‡»"éƒ¨ç½²åº”ç”¨"æŒ‰é’®

**å‰ç«¯å¤„ç†ï¼š**
```typescript
// app.ts - deployApp()
const deployUrl = await http.post<string>('/app/deploy', { 
  appId: id 
})

// æå– deployKey
const match = deployUrl.match(/\/static\/([^\/]+)/)
const deployKey = match ? match[1] : null
// ä¾‹å¦‚ä» "http://localhost:8123/api/static/html_123/" æå– "html_123"

// æ›´æ–°åº”ç”¨çŠ¶æ€
app.status = 'deployed'
app.deployKey = deployKey
```

**åç«¯å¤„ç†ï¼š**
```java
@PostMapping("/deploy")
public BaseResponse<String> deployApp(@RequestBody AppDeployRequest appDeployRequest, HttpServletRequest request) {
    Long appId = appDeployRequest.getAppId();
    User loginUser = userService.getLoginUser(request);
    String deployUrl = appService.deployApp(appId, loginUser);
    return ResultUtils.success(deployUrl);
    // è¿”å›å®Œæ•´URL: "http://localhost:8123/api/static/html_123/"
}
```

**é¢„æœŸç»“æœï¼š**
- âœ… æ˜¾ç¤º"æ­£åœ¨éƒ¨ç½²..."
- âœ… éƒ¨ç½²æˆåŠŸæ˜¾ç¤º"éƒ¨ç½²æˆåŠŸ"
- âœ… å³ä¾§iframeè‡ªåŠ¨åŠ è½½éƒ¨ç½²çš„åº”ç”¨
- âœ… åº”ç”¨çŠ¶æ€å˜ä¸º"å·²éƒ¨ç½²"

---

### æµç¨‹4: é¢„è§ˆéƒ¨ç½²çš„åº”ç”¨

**ç”¨æˆ·æ“ä½œï¼š**
1. æŸ¥çœ‹å³ä¾§iframeé¢„è§ˆ
2. æˆ–ç‚¹å‡»"æ–°çª—å£æ‰“å¼€"æŒ‰é’®

**å‰ç«¯å¤„ç†ï¼š**
```typescript
// Chat.vue
const previewUrl = ref('about:blank')

// éƒ¨ç½²æˆåŠŸåæ›´æ–°
updatePreviewUrl(app) {
  if (app?.deployKey) {
    previewUrl.value = `/api/static/${app.deployKey}/index.html`
  }
}
```

**é™æ€èµ„æºè®¿é—®ï¼š**
```java
@RestController
@RequestMapping("/static")
public class StaticResourceController {
    
    @GetMapping("/{deployKey}/**")
    public ResponseEntity<Resource> serveStaticResource(
            @PathVariable String deployKey,
            HttpServletRequest request) {
        
        // æ„å»ºæ–‡ä»¶è·¯å¾„
        String filePath = PREVIEW_ROOT_DIR + "/" + deployKey + resourcePath;
        File file = new File(filePath);
        
        // è¿”å›æ–‡ä»¶èµ„æº
        Resource resource = new FileSystemResource(file);
        return ResponseEntity.ok()
                .header("Content-Type", getContentTypeWithCharset(filePath))
                .body(resource);
    }
}
```

**è®¿é—®URLç¤ºä¾‹ï¼š**
```
http://localhost:5174/api/static/html_345567246724042752/index.html
â†“ (Viteä»£ç†)
http://localhost:8123/api/static/html_345567246724042752/index.html
```

**é¢„æœŸç»“æœï¼š**
- âœ… iframeæ˜¾ç¤ºç”Ÿæˆçš„åº”ç”¨
- âœ… åº”ç”¨å¯ä»¥æ­£å¸¸äº¤äº’
- âœ… æ ·å¼å’Œè„šæœ¬æ­£å¸¸åŠ è½½

---

## ğŸ› å½“å‰é—®é¢˜æ’æŸ¥

### é—®é¢˜1: åˆ›å»ºåç«‹å³è·å–è¯¦æƒ…å¤±è´¥

**åŸå› ï¼š** åº”ç”¨åˆ›å»ºåæ•°æ®åº“å†™å…¥å­˜åœ¨å»¶è¿Ÿ

**è§£å†³æ–¹æ¡ˆï¼š** âœ… å·²å®ç°è‡ªåŠ¨é‡è¯•æœºåˆ¶
```typescript
// Chat.vue
const loadAppData = async (retryCount = 0) => {
  const detail = await appStore.fetchAppDetail(appId.value)
  
  if (!detail && retryCount < 3) {
    // å»¶è¿Ÿåé‡è¯•ï¼š1s, 2s, 3s
    setTimeout(() => loadAppData(retryCount + 1), 1000 * (retryCount + 1))
    return
  }
}
```

### é—®é¢˜2: å¤§æ•´æ•°IDç²¾åº¦ä¸¢å¤±

**åŸå› ï¼š** åç«¯Longç±»å‹IDè¶…è¿‡JavaScriptå®‰å…¨æ•´æ•°èŒƒå›´

**ä¸´æ—¶æ–¹æ¡ˆï¼š** âœ… å·²å…¼å®¹å­—ç¬¦ä¸²å’Œæ•°å­—ç±»å‹
```typescript
let appId: number
if (typeof response === 'number') {
  appId = response
} else if (typeof response === 'string') {
  appId = parseInt(response, 10)
}
```

**æ¨èåç«¯é…ç½®ï¼š**
```java
@Configuration
public class JacksonConfig {
    @Bean
    public Jackson2ObjectMapperBuilderCustomizer jackson2ObjectMapperBuilderCustomizer() {
        return builder -> {
            // Longç±»å‹åºåˆ—åŒ–ä¸ºString
            builder.serializerByType(Long.class, ToStringSerializer.instance);
            builder.serializerByType(Long.TYPE, ToStringSerializer.instance);
        };
    }
}
```

---

## ğŸ“‹ å®Œæ•´æµ‹è¯•æ¸…å•

### æµ‹è¯•å‰å‡†å¤‡

- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆç«¯å£8123ï¼‰
- [ ] å‰ç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆç«¯å£5174ï¼‰
- [ ] å·²æ³¨å†Œæµ‹è¯•è´¦å·
- [ ] æµè§ˆå™¨å¼€å‘è€…å·¥å…·å·²æ‰“å¼€

### åŠŸèƒ½æµ‹è¯•

#### 1. ç”¨æˆ·è®¤è¯
- [ ] æ³¨å†Œæ–°ç”¨æˆ·
- [ ] ç™»å½•æˆåŠŸ
- [ ] åˆ·æ–°é¡µé¢åä»ä¿æŒç™»å½•çŠ¶æ€
- [ ] ç™»å‡ºåŠŸèƒ½æ­£å¸¸

#### 2. åˆ›å»ºåº”ç”¨
- [ ] è¾“å…¥ç®€å•æè¿°ï¼ˆå¦‚ï¼š"åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨"ï¼‰
- [ ] ç‚¹å‡»åˆ›å»ºï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º
- [ ] è‡ªåŠ¨è·³è½¬åˆ°å¯¹è¯é¡µé¢
- [ ] æ§åˆ¶å°æ— é”™è¯¯ä¿¡æ¯

#### 3. AIå¯¹è¯
- [ ] å‘é€æ¶ˆæ¯ï¼š"è¯·æ·»åŠ ä¸€ä¸ªæ ‡é¢˜"
- [ ] çœ‹åˆ°æµå¼è¾“å‡ºï¼ˆé€å­—æ˜¾ç¤ºï¼‰
- [ ] è¿›åº¦æ¡æ­£å¸¸æ˜¾ç¤º
- [ ] å¯¹è¯å†å²æ­£ç¡®æ˜¾ç¤º
- [ ] å¯ä»¥è¿ç»­å¯¹è¯å¤šè½®

#### 4. åº”ç”¨éƒ¨ç½²
- [ ] ç‚¹å‡»"éƒ¨ç½²åº”ç”¨"æŒ‰é’®
- [ ] æ˜¾ç¤º"éƒ¨ç½²æˆåŠŸ"
- [ ] å³ä¾§é¢„è§ˆè‡ªåŠ¨åŠ è½½
- [ ] é¢„è§ˆæ˜¾ç¤ºæ­£ç¡®çš„é¡µé¢

#### 5. åº”ç”¨ç®¡ç†
- [ ] è®¿é—®"æˆ‘çš„åº”ç”¨"åˆ—è¡¨
- [ ] çœ‹åˆ°åˆšåˆ›å»ºçš„åº”ç”¨
- [ ] åº”ç”¨çŠ¶æ€æ˜¾ç¤º"å·²éƒ¨ç½²"
- [ ] å¯ä»¥æœç´¢å’Œç­›é€‰

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. åˆ›å»ºåº”ç”¨ä¼˜åŒ–

**å½“å‰æµç¨‹ï¼š**
```
åˆ›å»º â†’ è¿”å›ID â†’ è·³è½¬ â†’ é‡è¯•è·å–è¯¦æƒ…ï¼ˆæœ€å¤š3æ¬¡ï¼Œ6ç§’ï¼‰
```

**ä¼˜åŒ–å»ºè®®ï¼š**
```java
// åç«¯ç›´æ¥è¿”å›å®Œæ•´AppVOå¯¹è±¡
@PostMapping("/add")
public BaseResponse<AppVO> addApp(...) {
    Long appId = appService.createApp(appAddRequest, loginUser);
    App app = appService.getById(appId);
    AppVO appVO = appService.getAppVO(app);
    return ResultUtils.success(appVO);
}
```

### 2. å¯¹è¯æ€§èƒ½ä¼˜åŒ–

**SSEè¿æ¥ç®¡ç†ï¼š**
- å¯¹è¯å®Œæˆåè‡ªåŠ¨å…³é—­è¿æ¥
- é¡µé¢å¸è½½æ—¶ä¸»åŠ¨æ–­å¼€
- é”™è¯¯æ—¶è‡ªåŠ¨é‡è¿

### 3. éƒ¨ç½²ä¼˜åŒ–

**å¢é‡éƒ¨ç½²ï¼š**
- ä»…éƒ¨ç½²ä¿®æ”¹çš„æ–‡ä»¶
- CDNç¼“å­˜é™æ€èµ„æº
- å‹ç¼©HTML/CSS/JS

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹APIè¯·æ±‚

**Networkæ ‡ç­¾ï¼š**
- ç­›é€‰XHR/FetchæŸ¥çœ‹APIè¯·æ±‚
- æŸ¥çœ‹Request Payload
- æŸ¥çœ‹Responseå†…å®¹
- æ£€æŸ¥çŠ¶æ€ç 

### 2. æŸ¥çœ‹SSEè¿æ¥

**Networkæ ‡ç­¾ï¼š**
- ç­›é€‰EventStreamç±»å‹
- æŸ¥çœ‹Messagesæ ‡ç­¾
- å®æ—¶æŸ¥çœ‹æ•°æ®æµ

### 3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

**å¼€å‘ç¯å¢ƒä¼šè¾“å‡ºï¼š**
```
APIå“åº”: /api/app/add {...}
åˆ›å»ºåº”ç”¨è¯·æ±‚å‚æ•°: {...}
åˆ›å»ºåº”ç”¨å“åº”: 345567246724042752 ç±»å‹: number
SSEæ¶ˆæ¯: {"d":"..."}
```

---

## âœ¨ åç»­åŠŸèƒ½å»ºè®®

### 1. åº”ç”¨ç‰ˆæœ¬ç®¡ç†
- ä¿å­˜æ¯æ¬¡å¯¹è¯çš„ä»£ç ç‰ˆæœ¬
- æ”¯æŒç‰ˆæœ¬å›æ»š
- å¯¹æ¯”ä¸åŒç‰ˆæœ¬å·®å¼‚

### 2. åº”ç”¨æ¨¡æ¿å¸‚åœº
- ç”¨æˆ·å¯ä»¥åˆ†äº«è‡ªå·±çš„åº”ç”¨
- å…¶ä»–ç”¨æˆ·å¯ä»¥å¤åˆ¶æ¨¡æ¿
- è¯„åˆ†å’Œè¯„è®ºç³»ç»Ÿ

### 3. ä»£ç ç¼–è¾‘å™¨
- é›†æˆMonaco Editor
- æ”¯æŒæ‰‹åŠ¨ç¼–è¾‘ä»£ç 
- è¯­æ³•é«˜äº®å’Œè‡ªåŠ¨è¡¥å…¨

### 4. åä½œåŠŸèƒ½
- å¤šäººåŒæ—¶ç¼–è¾‘åº”ç”¨
- å®æ—¶åŒæ­¥ä¿®æ”¹
- æƒé™ç®¡ç†

---

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æ“ä½œæ­¥éª¤**ï¼šå…·ä½“åšäº†ä»€ä¹ˆæ“ä½œ
2. **é¢„æœŸç»“æœ**ï¼šæœŸæœ›çœ‹åˆ°ä»€ä¹ˆ
3. **å®é™…ç»“æœ**ï¼šå®é™…å‘ç”Ÿäº†ä»€ä¹ˆ
4. **æ§åˆ¶å°æ—¥å¿—**ï¼šConsoleå’ŒNetworkæ ‡ç­¾çš„æˆªå›¾
5. **æµè§ˆå™¨ä¿¡æ¯**ï¼šæµè§ˆå™¨åç§°å’Œç‰ˆæœ¬

---

## ğŸ‰ å®Œæˆï¼

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½çš„APIå¯¹æ¥éƒ½å·²æ­£ç¡®å®ç°ï¼š
- âœ… ç”¨æˆ·è®¤è¯ï¼ˆç™»å½•ã€æ³¨å†Œï¼‰
- âœ… åº”ç”¨åˆ›å»ºï¼ˆåªéœ€initPromptï¼‰
- âœ… AIå¯¹è¯ç”Ÿæˆï¼ˆSSEæµå¼è¾“å‡ºï¼‰
- âœ… åº”ç”¨éƒ¨ç½²ï¼ˆè¿”å›å®Œæ•´URLï¼‰
- âœ… åº”ç”¨é¢„è§ˆï¼ˆé™æ€èµ„æºè®¿é—®ï¼‰

ç°åœ¨å¯ä»¥æ„‰å¿«åœ°ä½¿ç”¨AIç”Ÿæˆåº”ç”¨äº†ï¼ğŸš€

